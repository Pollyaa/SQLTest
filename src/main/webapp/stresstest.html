<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ë–î</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 min-h-screen flex">
<div id="root" class="w-full"></div>

<script type="text/babel">
    function DBTestingPage() {
        const [activeTest, setActiveTest] = React.useState("stress");
        const [queryType, setQueryType] = React.useState("SELECT");
        const [messages, setMessages] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        const [socket, setSocket] = React.useState(null);
        const [progress, setProgress] = React.useState({
            totalRequests: 0,
            threadCount: 0,
            failedRequests: 0,
            dbLoad: 0,
            iterationTime: 0,
            avgTime: 0,
            maxTime: undefined,
            minTime: undefined,
            failedRatio: 0,
            maxConnections: 0,
            maxQps: 0
        });

        const [testStarted, setTestStarted] = React.useState(false);
        const [completed, setCompleted] = React.useState(false);
        const [chartData, setChartData] = React.useState([]);
        const {LineChart, Line, CartesianGrid, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer} = window.Recharts;
        React.useEffect(() => {
            const ws = new WebSocket("ws://localhost:8081/ws");
            ws.onopen = () => console.log("üîó WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ");
            ws.onerror = error => console.error("–ü–æ–º–∏–ª–∫–∞ WebSocket:", error);
            ws.onmessage = event => {
                const data = JSON.parse(event.data);
                if (data.status === "max_connections_determined") {
                    setProgress(prev => ({...prev, maxConnections: data.max_connections}));
                } else if (data.status === "max_connections_test_started") {
                    setMessages(prev => [...prev, "üöÄ –ü–æ—á–∞—Ç–æ–∫ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑'—î–¥–Ω–∞–Ω—å..."]);
                } else if (data.status === "max_connections_test_completed") {
                    setMessages(prev => [...prev, "üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑'—î–¥–Ω–∞–Ω—å."]);
                } else if (data.status === "db_failure_detecting") {
                    setMessages(prev => [...prev, "‚úàÔ∏èÔ∏è –ü–æ—á–∞—Ç–æ–∫ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ —Å–µ–∫—É–Ω–¥—É..."]);
                } else if (data.status === "db_failure_found") {
                    setMessages(prev => [...prev, "üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ —Å–µ–∫—É–Ω–¥—É."]);
                } else if (data.status === "progress") {
                    const total = data.total_requests !== undefined ? data.total_requests : 0;
                    setProgress(prev => ({
                        ...prev,
                        totalRequests: total,
                        threadCount: data.threads !== undefined ? data.threads : prev.threadCount,
                        failedRequests: data.failed_requests !== undefined ? data.failed_requests : prev.failedRequests,
                        dbLoad: data.db_load !== undefined ? data.db_load : prev.dbLoad,
                        iterationTime: data.iteration_time_ms !== undefined ? data.iteration_time_ms : prev.iterationTime,
                        avgTime: data.avg_time_ms !== undefined ? data.avg_time_ms : prev.avgTime,
                        maxTime: data.max_time !== undefined ? data.max_time : prev.maxTime,
                        minTime: data.min_time !== undefined ? data.min_time : prev.minTime,
                        failedRatio: data.failed_ratio !== undefined ? data.failed_ratio : prev.failedRatio
                    }));
                    if (data.query_time !== undefined) {
                        setChartData(prev => [...prev, {total: total, query_time: data.query_time}]);
                    }
                } else if (data.status === "completed") {
                    if (!completed) {
                        const total = data.total_requests !== undefined ? data.total_requests : 0;
                        setMessages(prev => [...prev, "‚úÖ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ"]);
                        setProgress(prev => ({
                            totalRequests: total,
                            threadCount: prev.threadCount,
                            failedRequests: prev.failedRequests,
                            dbLoad: prev.dbLoad,
                            iterationTime: prev.iterationTime,
                            avgTime: data.avg_time,
                            maxTime: data.max_time,
                            minTime: data.min_time,
                            failedRatio: prev.failedRatio,
                            maxConnections: prev.maxConnections,
                            maxQps: data.max_qps
                        }));
                        setCompleted(true);
                        setLoading(false);
                    }
                } else if (data.status === "error") {
                    const errorMessages = {
                        error_max_connections: "–ü–æ–º–∏–ª–∫–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑'—î–¥–Ω–∞–Ω—å",
                        error_setup_tables: "–ü–æ–º–∏–ª–∫–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å",
                        error_closing_connection: "–ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑'—î–¥–Ω–∞–Ω–Ω—è",
                        error_connections_not_closed: "–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤—Å—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç—ñ",
                        error_query_insert: "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É INSERT",
                        error_query_select: "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É SELECT",
                        error_query_update: "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É UPDATE",
                        error_query_delete: "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É DELETE",
                        error_query_join: "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É JOIN"
                    };
                    const errorText = errorMessages[data.code] || "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞";
                    setMessages(prev => [...prev, "‚ùå " + errorText]);
                    setLoading(false);
                } else if (data.message) {
                    setMessages(prev => [...prev, data.message]);
                }
            };
            setSocket(ws);
            return () => ws.close();
        }, []);

        function resetTest() {
            setTestStarted(false);
            setMessages([]);
            setProgress({
                totalRequests: 0,
                threadCount: 0,
                failedRequests: 0,
                dbLoad: 0,
                iterationTime: 0,
                avgTime: 0,
                maxTime: undefined,
                minTime: undefined,
                failedRatio: 0,
                maxConnections: 0,
                maxQps: 0
            });
            setCompleted(false);
            setChartData([]);
        }

        function handleStartTest() {
            setCompleted(false);
            if (socket && socket.readyState === WebSocket.OPEN) {
                setLoading(true);
                setTestStarted(true);
                setMessages(prev => [...prev, "‚ö° –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—É..."]);
                socket.send(JSON.stringify({action: "start-test", queryType}));
            } else {
                setMessages(prev => [...prev, "‚ùå –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ WebSocket –≤—ñ–¥—Å—É—Ç–Ω—î"]);
            }
        }

        function handleStartStressTest() {
            setCompleted(false);
            if (socket && socket.readyState === WebSocket.OPEN) {
                setLoading(true);
                setTestStarted(true);
                setMessages(prev => [...prev, "‚ö° –ó–∞–ø—É—Å–∫ —Å—Ç—Ä–µ—Å-—Ç–µ—Å—Ç—É..."]);
                socket.send(JSON.stringify({action: "start-test", queryType: "STRESS"}));
            } else {
                setMessages(prev => [...prev, "‚ùå –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ WebSocket –≤—ñ–¥—Å—É—Ç–Ω—î"]);
            }
        }

        function handleDisconnect() {
            fetch("/api/disconnect", {method: "POST"})
                .then(response => response.json())
                .then(data => {
                    const disconnectMessage = data.success ? "‚úÖ –£—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ –≤—ñ–¥ –ë–î" : "‚ùå " + (data.error || "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ");
                    setMessages(prev => [...prev, disconnectMessage]);
                    if (data.success) {
                        setTimeout(() => {
                            window.location.href = "index.html"
                        }, 1500);
                    }
                })
                .catch(() => {
                    setMessages(prev => [...prev, "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –∑–∞–ø–∏—Ç—É"])
                });
        }

        function handleQueryTypeChange(e) {
            setQueryType(e.target.value);
            resetTest();
        }

        const timeUnit = queryType === "SELECT" ? "–º–∫—Å" : (queryType === "SELECT_JOIN" || queryType === "INSERT" || queryType === "DELETE") ? "–º—Å" : "—Å";
        return (
            <div className="flex min-h-screen">
                <aside className="w-64 bg-blue-700 text-white flex flex-col p-6 space-y-6">
                    <h2 className="text-2xl font-bold text-center">–ú–µ–Ω—é</h2>
                    <nav className="space-y-4">
                        <a href="connection.html"
                           className="block px-4 py-2 bg-blue-500 hover:bg-blue-400 rounded-lg transition">üîó
                            –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</a>
                        <a href="structure.html"
                           className="block px-4 py-2 bg-blue-500 hover:bg-blue-400 rounded-lg transition">üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞
                            –ë–î</a>
                        <a href="benchmark.html"
                           className={activeTest === "speed" ? "block px-4 py-2 bg-blue-800 rounded-lg transition" : "block px-4 py-2 bg-blue-500 hover:bg-blue-400 rounded-lg transition"}>‚öôÔ∏è
                            –¢–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ</a>
                        <a href="#" onClick={() => {
                            setActiveTest("stress");
                            resetTest();
                        }}
                           className={activeTest === "stress" ? "block px-4 py-2 bg-blue-800 rounded-lg transition" : "block px-4 py-2 bg-blue-500 hover:bg-blue-400 rounded-lg transition"}>üí•
                            –°—Ç—Ä–µ—Å-—Ç–µ—Å—Ç</a>
                        <button onClick={handleDisconnect}
                                className="block w-full text-left px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg transition">üö™
                            –í–∏–π—Ç–∏
                        </button>
                    </nav>
                </aside>
                <main className="flex-1 p-8">
                    {activeTest === "speed" &&
                        <div className="bg-white shadow-lg rounded-xl p-6 mb-6">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">‚öôÔ∏è –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –±–∞–∑–∏
                                –¥–∞–Ω–∏—Ö</h2>
                            <div className="mb-4">
                                <label className="block text-gray-700 font-bold">–¢–∏–ø –∑–∞–ø–∏—Ç—É:</label>
                                <select value={queryType} onChange={handleQueryTypeChange} disabled={testStarted}
                                        className="w-full p-2 border rounded">
                                    <option value="SELECT">SELECT</option>
                                    <option value="SELECT_JOIN">SELECT with JOIN</option>
                                    <option value="INSERT">INSERT</option>
                                    <option value="UPDATE">UPDATE</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            <button onClick={handleStartTest} disabled={testStarted}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition">–ó–∞–ø—É—Å—Ç–∏—Ç–∏
                                —Ç–µ—Å—Ç
                            </button>
                            {loading &&
                                <div className="mt-4 p-2 bg-yellow-100 rounded-md flex items-center">
                                    <svg className="animate-spin h-5 w-5 mr-2 text-yellow-500" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor"
                                              d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 018 8h-4l3 3 3-3h-4a8 8 0 01-8 8v-4l-3 3 3 3v-4a8 8 0 01-8-8z"></path>
                                    </svg>
                                    –ô–¥–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è, –±—É–¥—å –ª–∞—Å–∫–∞, –∑–∞—á–µ–∫–∞–π—Ç–µ...
                                </div>
                            }
                        </div>
                    }
                    {activeTest === "stress" &&
                        <div className="bg-white shadow-lg rounded-xl p-6 mb-6">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">üí• –°—Ç—Ä–µ—Å-—Ç–µ—Å—Ç –±–∞–∑–∏ –¥–∞–Ω–∏—Ö</h2>
                            <button onClick={handleStartStressTest} disabled={testStarted}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition">–ó–∞–ø—É—Å—Ç–∏—Ç–∏
                                —Ç–µ—Å—Ç
                            </button>
                            {loading &&
                                <div className="mt-4 p-2 bg-yellow-100 rounded-md flex items-center">
                                    <svg className="animate-spin h-5 w-5 mr-2 text-yellow-500" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor"
                                              d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 018 8h-4l3 3 3-3h-4a8 8 0 01-8 8v-4l-3 3 3 3v-4a8 8 0 01-8-8z"></path>
                                    </svg>
                                    –ô–¥–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è, –±—É–¥—å –ª–∞—Å–∫–∞, –∑–∞—á–µ–∫–∞–π—Ç–µ...
                                </div>
                            }
                        </div>
                    }
                    {testStarted &&
                        <React.Fragment>
                            <div className="bg-white shadow-lg rounded-xl p-6 mb-6">
                                <h3 className="text-2xl font-bold text-gray-700">üìù –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è</h3>
                                <p>üìå –í—Å—å–æ–≥–æ –∑–∞–ø–∏—Ç—ñ–≤: {progress.totalRequests}</p>
                                {activeTest === "speed" ? (
                                    <p>üìà –°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å
                                        –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: {progress.avgTime !== undefined ? progress.avgTime.toFixed(2) : "‚Äî"} {timeUnit}</p>
                                ) : (
                                    <p>üìà –°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å
                                        –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: {progress.avgTime !== undefined ? progress.avgTime.toFixed(2) : "‚Äî"} –º—Å</p>
                                )}
                                <hr className="my-4"/>
                                <p className="font-bold">üîå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–ª–∏–≤–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
                                    –∑'—î–¥–Ω–∞–Ω—å: {progress.maxConnections}</p>
                                <p className="font-bold">üóÉÔ∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–ª–∏–≤–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞
                                    —Å–µ–∫—É–Ω–¥—É: {progress.maxQps}</p>
                            </div>
                            <div className="bg-white shadow-lg rounded-xl p-6 mb-6">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">üîç –õ–æ–≥ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è</h3>
                                <div>
                                    {messages.filter(msg => !msg.startsWith("üîå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–ª–∏–≤–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑'—î–¥–Ω–∞–Ω—å:")).map((msg, index) =>
                                        <p key={index}>{msg}</p>
                                    )}
                                </div>
                            </div>
                            {chartData.length > 0 &&
                                <div className="bg-white shadow-lg rounded-xl p-6 mb-6">
                                    <h3 className="text-2xl font-bold text-gray-700">üìà –ì—Ä–∞—Ñ—ñ–∫ —á–∞—Å—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É</h3>
                                    <ResponsiveContainer width="100%" height={300}>
                                        <LineChart data={chartData}>
                                            <CartesianGrid strokeDasharray="3 3"/>
                                            <XAxis dataKey="total" tick={{fill: "#000000"}}/>
                                            {activeTest === "speed" ? (
                                                <YAxis tick={{fill: "#000000"}} label={{
                                                    value: "–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É, " + timeUnit,
                                                    angle: -90,
                                                    position: "insideLeft",
                                                    style: {textAnchor: "middle"}
                                                }}/>
                                            ) : (
                                                <YAxis tick={{fill: "#000000"}} label={{
                                                    value: "–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É, —Å",
                                                    angle: -90,
                                                    position: "insideLeft",
                                                    style: {textAnchor: "middle"}
                                                }}/>
                                            )}
                                            <Tooltip/>
                                            <Legend/>
                                            <Line type="monotone" dataKey="query_time" name="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤"
                                                  stroke="#8884d8" dot={false}/>
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            }
                        </React.Fragment>
                    }
                </main>
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<DBTestingPage/>);
</script>
</body>
</html>
